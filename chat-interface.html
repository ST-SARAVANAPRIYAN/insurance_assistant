<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Information & AI Assistant - Health Insurance Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .nav-button {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .nav-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-button.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1rem;
            flex: 1;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 1rem;
        }

        .chat-area {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .structured-response {
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }

        .structured-response:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .response-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.25rem 1.75rem;
            font-size: 1.15rem;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .response-header .header-icon {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .response-section {
            padding: 1.75rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .response-section:last-of-type {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e2e8f0;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 40px;
            height: 2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .response-footer {
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            padding: 1.25rem 1.75rem;
            font-style: italic;
            color: #4a5568;
            border-top: 1px solid #e2e8f0;
            font-size: 0.95rem;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 0.75rem;
        }

        .feature-list li {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            color: #4a5568;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .feature-list li:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .feature-list li:last-child {
            border-bottom: none;
        }

        /* Enhanced table styling with modern look - Support for proper HTML structure */
        .structured-response table, 
        .plan-table,
        table.plan-table,
        .structured-response .plan-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            font-size: 0.95rem;
            border: 2px solid #e2e8f0;
            outline: 1px solid #cbd5e0;
        }

        .structured-response table thead th, 
        .plan-table thead th,
        table.plan-table thead th,
        .structured-response .plan-table thead th,
        .structured-response table th, 
        .plan-table th,
        table.plan-table th,
        .structured-response .plan-table th {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            padding: 1.25rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid #2b6cb0;
        }

        .structured-response table tbody td,
        .plan-table tbody td,
        table.plan-table tbody td,
        .structured-response .plan-table tbody td,
        .structured-response table td, 
        .plan-table td,
        table.plan-table td,
        .structured-response .plan-table td {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
            line-height: 1.5;
            vertical-align: top;
        }

        .structured-response table tbody tr:last-child td, 
        .plan-table tbody tr:last-child td,
        table.plan-table tbody tr:last-child td,
        .structured-response .plan-table tbody tr:last-child td,
        .structured-response table tr:last-child td, 
        .plan-table tr:last-child td,
        table.plan-table tr:last-child td,
        .structured-response .plan-table tr:last-child td {
            border-bottom: none;
        }

        .structured-response table tbody tr:nth-child(even), 
        .plan-table tbody tr:nth-child(even),
        table.plan-table tbody tr:nth-child(even),
        .structured-response .plan-table tbody tr:nth-child(even),
        .structured-response table tr:nth-child(even), 
        .plan-table tr:nth-child(even),
        table.plan-table tr:nth-child(even),
        .structured-response .plan-table tr:nth-child(even) {
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
        }

        .structured-response table tbody tr:hover, 
        .plan-table tbody tr:hover,
        table.plan-table tbody tr:hover,
        .structured-response .plan-table tbody tr:hover,
        .structured-response table tr:hover, 
        .plan-table tr:hover,
        table.plan-table tr:hover,
        .structured-response .plan-table tr:hover {
            background: linear-gradient(135deg, #e6fffa, #f0fff4) !important;
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        /* Comparison table specific styling */
        .comparison-table {
            border: 2px solid #667eea;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            text-align: center;
        }

        .comparison-table td {
            text-align: center;
            font-weight: 500;
        }

        /* Table caption styling */
        .table-title {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: white;
            padding: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0;
            caption-side: top;
        }

        /* Enhanced message styling with better visual hierarchy */
        .message.bot .message-content {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .message.bot .message-content:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .message.bot .message-content p {
            padding: 1.5rem 1.75rem;
            margin: 0;
            line-height: 1.7;
            color: #2d3748;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 16px;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Code and technical content styling */
        .structured-response code {
            background: #e6fffa;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            color: #2c7a7b;
            font-size: 0.9rem;
            border: 1px solid #b2f5ea;
        }

        .structured-response pre {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            line-height: 1.6;
            border: 1px solid #4a5568;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced status indicators with icons */
        .status-success {
            color: #38a169;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-success::before {
            content: '✅';
            font-size: 1.1rem;
        }

        .status-warning {
            color: #d69e2e;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-warning::before {
            content: '⚠️';
            font-size: 1.1rem;
        }

        .status-error {
            color: #e53e3e;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-error::before {
            content: '❌';
            font-size: 1.1rem;
        }

        /* Enhanced highlighting for important information */
        .highlight-box {
            background: linear-gradient(135deg, #bee3f8, #e6fffa);
            border-left: 4px solid #4299e1;
            padding: 1.25rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .highlight-box.warning {
            background: linear-gradient(135deg, #fef5e7, #fffbeb);
            border-left-color: #f6ad55;
        }

        .highlight-box.success {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border-left-color: #68d391;
        }

        .highlight-box.error {
            background: linear-gradient(135deg, #fed7d7, #fef2f2);
            border-left-color: #fc8181;
        }

        /* Enhanced data visualization */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .data-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .data-card .data-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .data-card .data-label {
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
        }

        /* Plan selection in chat styles */
        .plan-selection-container {
            margin: 1rem 0;
        }

        .plan-selection-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .plan-selection-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .plan-selection-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .plan-selection-button:active {
            transform: translateY(0);
        }

        .plan-selection-button.selected {
            background: linear-gradient(135deg, #38a169, #2f855a);
            box-shadow: 0 4px 15px rgba(56, 161, 105, 0.4);
        }

        .plan-option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .plan-option-button {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            text-align: center;
            color: #4a5568;
        }

        .plan-option-button:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateY(-1px);
        }

        .plan-option-button.selected {
            border-color: #38a169;
            background: #f0fff4;
            color: #22543d;
            font-weight: 600;
        }

        /* Enhanced content highlighting */
        .highlight-amount {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #22543d;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
            border: 1px solid #9ae6b4;
        }

        .highlight-percentage {
            background: linear-gradient(135deg, #fef5e7, #ffd89b);
            color: #744210;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
            border: 1px solid #ffd89b;
        }

        /* Enhanced table animations - Support for proper HTML structure */
        .enhanced-table,
        table.enhanced-table,
        .structured-response .enhanced-table {
            animation: fadeInUp 0.6s ease-out;
        }

        .enhanced-table tr,
        table.enhanced-table tr,
        .structured-response .enhanced-table tr,
        .enhanced-table tbody tr,
        table.enhanced-table tbody tr,
        .structured-response .enhanced-table tbody tr {
            transition: all 0.3s ease;
        }

        .enhanced-table tr:hover,
        table.enhanced-table tr:hover,
        .structured-response .enhanced-table tr:hover,
        .enhanced-table tbody tr:hover,
        table.enhanced-table tbody tr:hover,
        .structured-response .enhanced-table tbody tr:hover {
            background: linear-gradient(135deg, #e6fffa, #f0fff4) !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced list animations */
        .enhanced-list li {
            animation: slideInLeft 0.4s ease-out;
            animation-fill-mode: both;
        }

        .enhanced-list li:nth-child(1) { animation-delay: 0.1s; }
        .enhanced-list li:nth-child(2) { animation-delay: 0.2s; }
        .enhanced-list li:nth-child(3) { animation-delay: 0.3s; }
        .enhanced-list li:nth-child(4) { animation-delay: 0.4s; }
        .enhanced-list li:nth-child(5) { animation-delay: 0.5s; }

        /* Animation keyframes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Interactive elements */
        .interactive-element {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .interactive-element:hover {
            animation: pulse 0.6s ease-in-out;
        }

        /* Loading states */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {

        /* Smooth transition classes */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .slide-down {
            animation: slideDown 0.5s ease-out;
        }

        .scale-in {
            animation: scaleIn 0.4s ease-out;
        }

        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }

        /* Chat clearing animation */
        .chat-clearing {
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease-out;
        }

        .chat-cleared {
            opacity: 1;
            transform: translateY(0);
            animation: bounceIn 0.8s ease-out;
        }

        /* Enhanced plan selection container */
        .plan-selection-container {
            animation: slideDown 0.6s ease-out;
        }

        .plan-selection-button {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .plan-selection-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Enhanced menu options after responses */
        .menu-options {
            animation: fadeInUp 0.8s ease-out;
        }

        .menu-option {
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInLeft 0.5s ease-out forwards;
        }

        .menu-option:nth-child(1) { animation-delay: 0.1s; }
        .menu-option:nth-child(2) { animation-delay: 0.2s; }
        .menu-option:nth-child(3) { animation-delay: 0.3s; }
        .menu-option:nth-child(4) { animation-delay: 0.4s; }
        .menu-option:nth-child(5) { animation-delay: 0.5s; }

        /* Smooth message transitions */
        .message {
            animation: none; /* Remove old animation */
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .message.user {
            animation: none; /* Remove old animation */
        }

        .message.bot {
            animation: none; /* Remove old animation */
        }

        .message-entering {
            opacity: 0;
            transform: translateY(30px);
        }

        /* Typing indicator styles */
        .typing-placeholder {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            margin: 4px 0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typingDots 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingDots {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Typewriter effect */
        .typewriter {
            overflow: hidden;
            border-right: 2px solid #667eea;
            white-space: nowrap;
            animation: typing 0.5s steps(40, end), blink-caret 1s step-end infinite;
        }

        @keyframes typing {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        @keyframes blink-caret {
            from, to {
                border-color: transparent;
            }
            50% {
                border-color: #667eea;
            }
        }

        /* Smooth scrolling for chat */
        #chatMessages {
            scroll-behavior: smooth;
        }
            .main-content {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .sidebar {
                position: static;
                margin-bottom: 1rem;
                padding: 1rem;
            }

            .structured-response {
                margin: 10px 0;
            }

            .response-header {
                padding: 1rem;
                font-size: 1rem;
            }

            .response-section {
                padding: 1rem;
            }

            .structured-response table th,
            .structured-response table td,
            .plan-table th,
            .plan-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .feature-list li {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .plan-selection-buttons {
                grid-template-columns: 1fr;
            }
            
            .plan-option-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }

            .header {
                padding: 0.75rem 1rem;
                margin-bottom: 0.5rem;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .nav-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .structured-response table {
                font-size: 0.8rem;
            }

            .structured-response table th,
            .structured-response table td {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Accessibility Improvements */
        .structured-response:focus-within {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .enhanced-table tr:focus {
            outline: 2px solid #4299e1;
            outline-offset: -1px;
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Enhanced plan info styling */

        .plan-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            margin-bottom: 1rem;
        }

        .plan-info {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
            display: none;
        }

        .plan-info h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .plan-info p {
            color: #4a5568;
            font-size: 0.8rem;
            line-height: 1.4;
            margin-bottom: 0.3rem;
        }

        .chat-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-button {
            padding: 0.6rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-button:hover {
            background: #f7fafc;
            border-color: #667eea;
        }

        .status-indicator {
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .current-plan-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .current-plan-info .section-title {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .current-plan-info p {
            margin: 0.25rem 0;
            color: #1e40af;
        }

        .status-connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-processing {
            background: #fef5e7;
            color: #744210;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }

        .chat-header h2 {
            color: #2d3748;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .chat-header p {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 500px;
            background: #fafafa;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform, opacity;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #667eea;
            color: white;
        }

        .message.bot .message-avatar {
            background: #48bb78;
            color: white;
        }

        .message-content {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 80%;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .message.bot .message-content {
            background: white;
            color: #2d3748;
        }

        .message-content.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 0.5rem;
            align-items: end;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: #5a67d8;
        }

        .send-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 0.5rem 1rem;
            color: #a0aec0;
            font-style: italic;
            font-size: 0.9rem;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 60% { content: '...'; }
            30% { content: '..'; }
            90% { content: '.'; }
        }

        .structured-response {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .response-header {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .response-section {
            margin-bottom: 0.75rem;
        }

        .section-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .feature-list {
            list-style: none;
            margin-left: 0;
        }

        .feature-list li {
            padding: 0.25rem 0;
            color: #4a5568;
        }

        .response-footer {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .empty-chat {
            text-align: center;
            padding: 3rem 1rem;
            color: #a0aec0;
        }

        .empty-chat-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-chat h3 {
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .empty-chat p {
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .container {
                padding: 0.5rem;
            }

            .chat-messages {
                max-height: 400px;
            }

            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>💬 AI Chat Assistant</h1>
            <nav class="nav-bar">
                <a href="/" class="nav-button">🏠 Home</a>
                <a href="/plans" class="nav-button">📋 Plans</a>
                <a href="/chat" class="nav-button active">💬 Chat</a>
                <a href="/claims" class="nav-button">🔍 Assessment</a>
            </nav>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <!-- Hidden plan selectors for logic - not displayed to user -->
                <div style="display: none;">
                    <select id="companySelect" onchange="handleCompanyChange()">
                        <option value="">Select Insurance Company</option>
                    </select>
                    <select id="planSelect" onchange="handlePlanChange()" disabled>
                        <option value="">First select insurance company</option>
                    </select>
                    <select id="variantSelect" onchange="handleVariantChange()" disabled>
                        <option value="">First select plan</option>
                    </select>
                    <div class="plan-info" id="planInfo">
                        <h4>Selected Plan Details</h4>
                        <div id="planDescription"></div>
                    </div>
                </div>

                <div class="status-indicator" id="statusIndicator">
                    🔄 Initializing...
                </div>

                <div class="current-plan-info" id="currentPlanInfo" style="display: none;">
                    <div class="section-title">📋 Current Plan</div>
                    <div id="currentPlanDetails"></div>
                </div>

                <div class="section-title">🛠️ Chat Controls</div>
                <div class="chat-controls">
                    <button class="chat-button" onclick="restartPlanSelection()">
                        🔄 Change Plan
                    </button>
                    <button class="chat-button" onclick="clearCurrentChat()">
                        🗑️ Clear Chat
                    </button>
                    <button class="chat-button" onclick="exportChat()">
                        💾 Export Chat
                    </button>
                </div>
            </aside>

            <main class="chat-area">
                <div class="chat-header">
                    <h2>AI Assistant</h2>
                    <p>Get instant help with your insurance claims and policy questions</p>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="empty-chat">
                        <div class="empty-chat-icon">💬</div>
                        <h3>Start a Conversation</h3>
                        <p>Select your insurance plan and ask me anything about claims, coverage, or policy details.</p>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span class="typing-dots">AI is typing</span>
                </div>

                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Type your message here... (Shift+Enter for new line)"
                            onkeydown="handleKeyDown(event)"
                            oninput="adjustTextareaHeight()"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            Send
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Global state
        let currentPlan = '';
        let conversationHistory = [];
        let isProcessing = false;
        const PLAN_INFO = {};

        // Initialize the application
        async function initializeApp() {
            console.log('🔧 Chat interface initializing...');
            await loadAvailablePlans();
            loadConversationHistory();
            showStatus('Ready to chat', 'connected');
            adjustTextareaHeight();
            
            // Check for claim context in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const claimContext = urlParams.get('claimContext');
            
            if (claimContext) {
                try {
                    const claimData = JSON.parse(decodeURIComponent(claimContext));
                    handleClaimContext(claimData);
                } catch (error) {
                    console.error('Error parsing claim context:', error);
                }
            } else {
                // Show general welcome message if no conversation history and no plan selected
                if (conversationHistory.length === 0 && !currentPlan) {
                    clearEmptyState();
                    showPlanSelectionInChat();
                }
            }
        }
        
        // Handle claim context from URL
        function handleClaimContext(claimData) {
            // Add a welcome message with claim context
            const welcomeMessage = `
                <div class="structured-response">
                    <div class="response-header">
                        🎉 <strong>Welcome from Claim Assessment!</strong>
                    </div>
                    <div class="response-section">
                        <div class="section-title">📋 Your Claim Details</div>
                        <p><strong>Patient:</strong> ${claimData.patientName}</p>
                        <p><strong>Plan:</strong> ${claimData.planName}</p>
                        <p><strong>Condition:</strong> ${claimData.medicalCondition}</p>
                        <p><strong>Claim Amount:</strong> ₹${claimData.claimAmount?.toLocaleString()}</p>
                        <p><strong>Status:</strong> ${claimData.eligible ? '✅ Eligible' : '❌ Not Eligible'}</p>
                    </div>
                    <div class="response-section">
                        <div class="section-title">💡 How I can help</div>
                        <p>I have context about your recent claim assessment. Ask me about:</p>
                        <ul class="feature-list">
                            <li>📋 Documentation requirements</li>
                            <li>🏥 Hospital network information</li>
                            <li>⏱️ Claim processing steps</li>
                            <li>📞 Next steps and recommendations</li>
                        </ul>
                    </div>
                    <div class="response-footer">
                        What would you like to know about your claim?
                    </div>
                </div>
            `;
            
            // Clear any existing conversation and add welcome message
            conversationHistory = [];
            clearEmptyState();
            addBotMessage(welcomeMessage, false, true);
            
            // Store claim context for use in API calls
            window.claimContext = claimData;
        }

        // Load available plans and organize hierarchically
        async function loadAvailablePlans() {
            console.log('🔄 Loading available plans...');
            try {
                const response = await fetch('/api/plans/list');
                console.log('📡 API Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    const allPlans = data.plans || [];
                    console.log('📋 Plans received:', allPlans.length);
                    
                    if (allPlans.length === 0) {
                        console.warn('⚠️ No plans found in data');
                        document.getElementById('companySelect').innerHTML = `<option value="">No companies available</option>`;
                        return;
                    }
                    
                    // Organize data hierarchically
                    const companies = {};
                    allPlans.forEach(plan => {
                        const companyName = plan.company;
                        if (!companies[companyName]) {
                            companies[companyName] = {};
                        }
                        
                        const planName = plan.planName;
                        if (!companies[companyName][planName]) {
                            companies[companyName][planName] = [];
                        }
                        
                        companies[companyName][planName].push({
                            sumInsured: plan.sumInsuredRange || 'Unknown',
                            filePath: plan.filePath,
                            fullPlan: plan
                        });
                    });
                    
                    // Store organized data globally
                    window.chatPlanHierarchy = companies;
                    
                    // Populate company dropdown
                    populateCompanies(Object.keys(companies).sort());
                    
                    console.log('✅ Plans loaded and organized hierarchically');
                    console.log('🏢 Companies:', Object.keys(companies));
                    
                } else {
                    console.error('❌ Failed to load plans from API, status:', response.status);
                    document.getElementById('companySelect').innerHTML = `<option value="">Failed to load companies - Check server</option>`;
                }
            } catch (error) {
                console.error('❌ Error loading plans:', error);
                document.getElementById('companySelect').innerHTML = `<option value="">Error loading companies - Check connection</option>`;
            }
        }

        // Populate company dropdown
        function populateCompanies(companies) {
            const companySelect = document.getElementById('companySelect');
            companySelect.innerHTML = '<option value="">Select Insurance Company</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
        }

        // Handle company selection
        function handleCompanyChange() {
            const companySelect = document.getElementById('companySelect');
            const planSelect = document.getElementById('planSelect');
            const variantSelect = document.getElementById('variantSelect');
            const selectedCompany = companySelect.value;
            
            if (!selectedCompany) {
                planSelect.innerHTML = '<option value="">First select insurance company</option>';
                planSelect.disabled = true;
                variantSelect.innerHTML = '<option value="">First select plan</option>';
                variantSelect.disabled = true;
                hidePlanInfo();
                return;
            }
            
            const plans = window.chatPlanHierarchy[selectedCompany];
            if (!plans) {
                planSelect.innerHTML = '<option value="">No plans available for this company</option>';
                planSelect.disabled = true;
                return;
            }
            
            // Populate plans dropdown
            planSelect.innerHTML = '<option value="">Select Plan</option>';
            Object.keys(plans).sort().forEach(planName => {
                const option = document.createElement('option');
                option.value = planName;
                option.textContent = planName;
                planSelect.appendChild(option);
            });
            
            planSelect.disabled = false;
            variantSelect.innerHTML = '<option value="">First select plan</option>';
            variantSelect.disabled = true;
            hidePlanInfo();
            
            console.log(`✅ Loaded ${Object.keys(plans).length} plans for ${selectedCompany}`);
        }

        // Handle plan selection
        function handlePlanChange() {
            const companySelect = document.getElementById('companySelect');
            const planSelect = document.getElementById('planSelect');
            const variantSelect = document.getElementById('variantSelect');
            const selectedCompany = companySelect.value;
            const selectedPlan = planSelect.value;
            
            if (!selectedCompany || !selectedPlan) {
                variantSelect.innerHTML = '<option value="">First select plan</option>';
                variantSelect.disabled = true;
                hidePlanInfo();
                return;
            }
            
            const variants = window.chatPlanHierarchy[selectedCompany][selectedPlan];
            if (!variants) {
                variantSelect.innerHTML = '<option value="">No variants available for this plan</option>';
                variantSelect.disabled = true;
                return;
            }
            
            // Populate variants dropdown
            variantSelect.innerHTML = '<option value="">Select Plan Variant</option>';
            variants.forEach(variant => {
                const option = document.createElement('option');
                option.value = variant.sumInsured;
                option.textContent = `₹${variant.sumInsured}`;
                option.dataset.filePath = variant.filePath;
                option.dataset.company = selectedCompany;
                option.dataset.planName = selectedPlan;
                variantSelect.appendChild(option);
            });
            
            variantSelect.disabled = false;
            hidePlanInfo();
            
            console.log(`✅ Loaded ${variants.length} variants for ${selectedPlan}`);
        }

        // Handle variant selection
        async function handleVariantChange() {
            const companySelect = document.getElementById('companySelect');
            const planSelect = document.getElementById('planSelect');
            const variantSelect = document.getElementById('variantSelect');
            
            const selectedCompany = companySelect.value;
            const selectedPlan = planSelect.value;
            const selectedVariant = variantSelect.value;
            
            if (!selectedCompany || !selectedPlan || !selectedVariant) {
                hidePlanInfo();
                return;
            }
            
            const selectedOption = variantSelect.options[variantSelect.selectedIndex];
            const planFilePath = selectedOption.dataset.filePath;
            
            // Update current plan info
            currentPlan = {
                company: selectedCompany,
                planName: selectedPlan,
                sumInsured: selectedVariant,
                filePath: planFilePath
            };
            
            // Show plan information
            showPlanInfo(currentPlan);
            updateCurrentPlanDisplay(currentPlan);
            
            // Load full plan details
            try {
                showStatus('Loading plan details...', 'processing');
                const response = await fetch(`/api/plans/get?filePath=${encodeURIComponent(planFilePath)}`);
                if (response.ok) {
                    const planData = await response.json();
                    currentPlan.fullData = planData.data;
                    showStatus('Plan loaded - Ready to chat', 'connected');
                } else {
                    showStatus('Plan selected - Limited data', 'error');
                }
            } catch (error) {
                console.error('Error loading plan details:', error);
                showStatus('Plan selected - Basic info only', 'error');
            }
            
            // Add welcome message if this is the first plan selection
            if (conversationHistory.length === 0) {
                addBotMessage(generateWelcomeMessage(currentPlan), false);
            }
        }

        // Update current plan display in sidebar
        function updateCurrentPlanDisplay(planData) {
            const currentPlanInfo = document.getElementById('currentPlanInfo');
            const currentPlanDetails = document.getElementById('currentPlanDetails');
            
            if (planData && planData.company) {
                currentPlanDetails.innerHTML = `
                    <p><strong>Company:</strong> ${planData.company}</p>
                    <p><strong>Plan:</strong> ${planData.planName}</p>
                    <p><strong>Coverage:</strong> ₹${planData.sumInsured}</p>
                `;
                currentPlanInfo.style.display = 'block';
            } else {
                currentPlanInfo.style.display = 'none';
            }
        }

        // Show plan selection in chat as bot message
        function showPlanSelectionInChat() {
            const companies = window.chatPlanHierarchy;
            if (!companies || Object.keys(companies).length === 0) {
                addBotMessage(`
                    <div class="structured-response bounce-in">
                        <div class="response-header">
                            🤖 <strong>Welcome to Insurance Assistant!</strong>
                        </div>
                        <div class="response-section">
                            <p>I'm loading available insurance plans for you. Please wait a moment...</p>
                        </div>
                    </div>
                `, false, false);
                return;
            }

            const companyButtons = Object.keys(companies).sort().map((company, index) => 
                `<button class="plan-selection-button menu-option" style="animation-delay: ${0.1 * (index + 1)}s;" onclick="selectCompanyInChat('${company}')">${company}</button>`
            ).join('');

            const welcomeMessage = `
                <div class="structured-response bounce-in">
                    <div class="response-header">
                        🤖 <strong>Welcome to Insurance Assistant!</strong>
                    </div>
                    <div class="response-section">
                        <div class="section-title slide-down">📋 Please Select Your Insurance Company</div>
                        <p class="fade-in" style="animation-delay: 0.3s;">Choose your insurance company to get started with personalized assistance:</p>
                        <div class="plan-selection-buttons plan-selection-container">
                            ${companyButtons}
                        </div>
                    </div>
                    <div class="response-footer fade-in" style="animation-delay: 0.5s;">
                        Click on your insurance company to continue
                    </div>
                </div>
            `;

            addBotMessage(welcomeMessage, false, false);
        }

        // Handle company selection in chat
        function selectCompanyInChat(company) {
            // Update hidden select to maintain backend logic
            const companySelect = document.getElementById('companySelect');
            companySelect.value = company;
            handleCompanyChange();

            // Add user message showing selection
            addUserMessage(`I want to select ${company}`, false);

            // Show plan selection
            const plans = window.chatPlanHierarchy[company];
            if (!plans) {
                addBotMessage('Sorry, no plans are available for this company.', true, false);
                return;
            }

            const planButtons = Object.keys(plans).sort().map((planName, index) => 
                `<button class="plan-option-button menu-option" style="animation-delay: ${0.1 * (index + 1)}s;" onclick="selectPlanInChat('${company}', '${planName}')">${planName}</button>`
            ).join('');

            const planMessage = `
                <div class="structured-response scale-in">
                    <div class="response-header">
                        ✅ <strong>${company} Selected!</strong>
                    </div>
                    <div class="response-section">
                        <div class="section-title slide-down">📋 Please Select Your Insurance Plan</div>
                        <p class="fade-in" style="animation-delay: 0.2s;">Great choice! Now please select your specific insurance plan:</p>
                        <div class="plan-option-grid plan-selection-container">
                            ${planButtons}
                        </div>
                    </div>
                    <div class="response-footer fade-in" style="animation-delay: 0.4s;">
                        Click on your insurance plan to continue
                    </div>
                </div>
            `;

            addBotMessage(planMessage, false, false);
        }

        // Handle plan selection in chat
        function selectPlanInChat(company, planName) {
            // Update hidden select to maintain backend logic
            const planSelect = document.getElementById('planSelect');
            planSelect.value = planName;
            handlePlanChange();

            // Add user message showing selection
            addUserMessage(`I want to select ${planName}`, false);

            // Show variant selection
            const variants = window.chatPlanHierarchy[company][planName];
            if (!variants) {
                addBotMessage('Sorry, no variants are available for this plan.', true, false);
                return;
            }

            const variantButtons = variants.map((variant, index) => 
                `<button class="plan-option-button menu-option" style="animation-delay: ${0.1 * (index + 1)}s;" onclick="selectVariantInChat('${company}', '${planName}', '${variant.sumInsured}', '${variant.filePath}')">${variant.sumInsured}</button>`
            ).join('');

            const variantMessage = `
                <div class="structured-response scale-in">
                    <div class="response-header">
                        ✅ <strong>${planName} Selected!</strong>
                    </div>
                    <div class="response-section">
                        <div class="section-title slide-down">💰 Please Select Your Coverage Amount</div>
                        <p class="fade-in" style="animation-delay: 0.2s;">Perfect! Now please select your sum insured amount:</p>
                        <div class="plan-option-grid plan-selection-container">
                            ${variantButtons}
                        </div>
                    </div>
                    <div class="response-footer fade-in" style="animation-delay: 0.4s;">
                        Click on your desired coverage amount
                    </div>
                </div>
            `;

            addBotMessage(variantMessage, false, false);
        }

        // Handle variant selection in chat
        async function selectVariantInChat(company, planName, sumInsured, filePath) {
            // Update hidden select to maintain backend logic
            const variantSelect = document.getElementById('variantSelect');
            const option = Array.from(variantSelect.options).find(opt => opt.value === sumInsured);
            if (option) {
                variantSelect.value = sumInsured;
                option.dataset.filePath = filePath;
                option.dataset.company = company;
                option.dataset.planName = planName;
                await handleVariantChange();
            }

            // Update current plan display in sidebar
            updateCurrentPlanDisplay({
                company: company,
                planName: planName,
                sumInsured: sumInsured
            });

            // Add user message showing selection
            addUserMessage(`I want coverage of ₹${sumInsured}`, false);

            // Show completion message
            const completionMessage = `
                <div class="structured-response">
                    <div class="response-header">
                        🎉 <strong>Plan Setup Complete!</strong>
                    </div>
                    <div class="response-section">
                        <div class="section-title">✅ Your Selected Plan</div>
                        <p><strong>Company:</strong> ${company}</p>
                        <p><strong>Plan:</strong> ${planName}</p>
                        <p><strong>Coverage:</strong> ₹${sumInsured}</p>
                    </div>
                    <div class="response-section">
                        <div class="section-title">� What would you like to know about your plan?</div>
                        <p>Please select an option to explore your plan details:</p>
                        <div class="plan-option-grid">
                            <button class="plan-option-button" onclick="queryPlanDetail('basic plan details')">📄 Basic Plan Details</button>
                            <button class="plan-option-button" onclick="queryPlanDetail('full plan details')">📋 Full Plan Details</button>
                            <button class="plan-option-button" onclick="queryPlanDetail('basic coverages')">🏥 Basic Coverages</button>
                            <button class="plan-option-button" onclick="queryPlanDetail('exclusions waiting periods')">❌ Exclusions & Waiting Periods</button>
                            <button class="plan-option-button" onclick="queryPlanDetail('sub limits')">💰 Sub Limits</button>
                            <button class="plan-option-button" onclick="queryPlanDetail('renewal benefits')">🔄 Renewal Benefits</button>
                            <button class="plan-option-button" onclick="queryPlanDetail('special features others')">⭐ Special Features</button>
                            <button class="plan-option-button" onclick="queryPlanDetail('maternity cover')">👶 Maternity Cover</button>
                        </div>
                    </div>
                    <div class="response-footer">
                        💬 You can also type any specific questions about your policy
                    </div>
                </div>
            `;

            addBotMessage(completionMessage, false, false);
        }

        // Handle plan detail queries
        async function queryPlanDetail(detailType) {
            // Add user message showing what they selected
            const detailLabels = {
                'basic plan details': 'Basic Plan Details',
                'full plan details': 'Full Plan Details',
                'basic coverages': 'Basic Coverages',
                'exclusions waiting periods': 'Exclusions & Waiting Periods',
                'sub limits': 'Sub Limits',
                'renewal benefits': 'Renewal Benefits',
                'special features others': 'Special Features',
                'maternity cover': 'Maternity Cover'
            };
            
            const selectedLabel = detailLabels[detailType] || detailType;
            addUserMessage(`Show me ${selectedLabel}`, false);
            
            // Show typing indicator
            showTypingIndicator(true);
            isProcessing = true;
            
            try {
                let queryMessage = '';
                
                // Handle different types of queries
                if (detailType === 'basic plan details') {
                    queryMessage = 'Please provide only the basic plan details section (plan_details) from my selected insurance plan. Show only the basic information like company, plan name, age entry, sum insured range, policy duration, payment mode, who can be covered, mid-term inclusion, and medical screening requirements.';
                } else if (detailType === 'full plan details') {
                    queryMessage = 'Please provide all comprehensive details about my selected insurance plan including all sections and subsections.';
                } else {
                    queryMessage = `Please provide detailed information about ${detailType} for my selected insurance plan.`;
                }
                
                // Get AI response for the specific detail type
                const response = await getAIResponse(queryMessage);
                addBotMessage(response);
                
                // After showing the detail, offer to see other sections or ask questions
                setTimeout(() => {
                    const followUpMessage = `
                        <div class="structured-response">
                            <div class="response-section">
                                <div class="section-title">🔍 Explore More Plan Details</div>
                                <div class="plan-option-grid">
                                    <button class="plan-option-button" onclick="queryPlanDetail('basic plan details')">📄 Basic Plan Details</button>
                                    <button class="plan-option-button" onclick="queryPlanDetail('full plan details')">📋 Full Plan Details</button>
                                    <button class="plan-option-button" onclick="queryPlanDetail('basic coverages')">🏥 Basic Coverages</button>
                                    <button class="plan-option-button" onclick="queryPlanDetail('exclusions waiting periods')">❌ Exclusions & Waiting Periods</button>
                                    <button class="plan-option-button" onclick="queryPlanDetail('sub limits')">💰 Sub Limits</button>
                                    <button class="plan-option-button" onclick="queryPlanDetail('renewal benefits')">🔄 Renewal Benefits</button>
                                    <button class="plan-option-button" onclick="queryPlanDetail('special features others')">⭐ Special Features</button>
                                    <button class="plan-option-button" onclick="queryPlanDetail('maternity cover')">👶 Maternity Cover</button>
                                </div>
                            </div>
                            <div class="response-footer">
                                💬 Or ask me any specific questions about your policy
                            </div>
                        </div>
                    `;
                    addBotMessage(followUpMessage, false, false);
                }, 1000);
                
            } catch (error) {
                console.error('❌ Plan detail query error:', error);
                addBotMessage('I apologize, but I encountered an error retrieving that plan detail. Please try again or ask a specific question about your policy.', true);
            } finally {
                showTypingIndicator(false);
                isProcessing = false;
            }
        }

        // Restart plan selection
        function restartPlanSelection() {
            // Reset current plan
            currentPlan = '';
            
            // Reset hidden selects
            document.getElementById('companySelect').value = '';
            document.getElementById('planSelect').value = '';
            document.getElementById('planSelect').disabled = true;
            document.getElementById('variantSelect').value = '';
            document.getElementById('variantSelect').disabled = true;
            hidePlanInfo();
            
            // Hide current plan display
            document.getElementById('currentPlanInfo').style.display = 'none';
            
            // Add user message
            addUserMessage('I want to change my plan selection', false);
            
            // Show plan selection again
            showPlanSelectionInChat();
        }

        // Update current plan display in sidebar
        function updateCurrentPlanDisplay(planData) {
            const currentPlanInfo = document.getElementById('currentPlanInfo');
            const currentPlanDetails = document.getElementById('currentPlanDetails');
            
            if (!planData) {
                currentPlanInfo.style.display = 'none';
                return;
            }
            
            currentPlanDetails.innerHTML = `
                <p><strong>Company:</strong> ${planData.company}</p>
                <p><strong>Plan:</strong> ${planData.planName}</p>
                <p><strong>Coverage:</strong> ₹${planData.sumInsured}</p>
            `;
            currentPlanInfo.style.display = 'block';
        }
        async function changePlan() {
            const planSelect = document.getElementById('planSelect');
            const planInfo = document.getElementById('planInfo');
            const planDescription = document.getElementById('planDescription');
            
            currentPlan = planSelect.value;
            
            if (currentPlan) {
                const plan = PLAN_INFO[currentPlan];
                
                try {
                    // Load full plan data if not already loaded
                    if (!plan.fullData && plan.filePath) {
                        showStatus('Loading plan details...', 'processing');
                        const response = await fetch(`/api/plans/get?filePath=${encodeURIComponent(plan.filePath)}`);
                        if (response.ok) {
                            const planData = await response.json();
                            plan.fullData = planData.data;
                        }
                    }
                    
                    planInfo.style.display = 'block';
                    planDescription.innerHTML = `
                        <p><strong>Company:</strong> ${plan.company}</p>
                        <p><strong>Coverage:</strong> ${plan.sumInsured}</p>
                        <p><strong>Book:</strong> ${plan.book}</p>
                        ${plan.fullData ? `<p><strong>Status:</strong> Full plan data loaded</p>` : ''}
                    `;
                    
                    showStatus('Plan selected - Ready to chat', 'connected');
                    
                    // Add a welcome message about the selected plan
                    if (conversationHistory.length === 0) {
                        addBotMessage(`
                            <div class="structured-response">
                                <div class="response-header">
                                    🎉 <strong>Plan Selected Successfully!</strong>
                                </div>
                                <div class="response-section">
                                    <div class="section-title">✅ Your Selected Plan</div>
                                    <p><strong>Plan:</strong> ${plan.name}</p>
                                    <p><strong>Company:</strong> ${plan.company}</p>
                                    <p><strong>Coverage:</strong> ${plan.sumInsured}</p>
                                </div>
                                <div class="response-section">
                                    <div class="section-title">💡 How I can help</div>
                                    <ul class="feature-list">
                                        <li>🔍 <strong>Analyze claim eligibility</strong> based on your plan</li>
                                        <li>📋 <strong>List required documents</strong> for your claim type</li>
                                        <li>💰 <strong>Calculate coverage amounts</strong> and co-payments</li>
                                        <li>⚡ <strong>Answer policy questions</strong> specific to your plan</li>
                                    </ul>
                                </div>
                                <div class="response-footer">
                                    💬 What would you like to know about your policy?
                                </div>
                            </div>
                        `, false);
                    }
                    
                } catch (error) {
                    console.error('Error loading plan details:', error);
                    planInfo.style.display = 'block';
                    planDescription.innerHTML = `
                        <p><strong>Company:</strong> ${plan.company}</p>
                        <p><strong>Coverage:</strong> ${plan.sumInsured}</p>
                        <p><strong>Status:</strong> Basic info only</p>
                    `;
                    showStatus('Plan selected - Limited data', 'error');
                }
                
            } else {
                planInfo.style.display = 'none';
                showStatus('Please select a plan', 'processing');
            }
        }

        // Chat functionality
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message || isProcessing) return;
            
            console.log('📤 Sending message:', message);
            
            // Clear empty chat state
            clearEmptyState();
            
            // Add user message
            addUserMessage(message);
            chatInput.value = '';
            adjustTextareaHeight();
            
            // Show typing indicator
            showTypingIndicator(true);
            isProcessing = true;
            
            try {
                // Get AI response
                console.log('🤖 Requesting AI response...');
                const response = await getAIResponse(message);
                console.log('📥 Received AI response:', response);
                addBotMessage(response);
            } catch (error) {
                console.error('❌ Chat error:', error);
                addBotMessage('I apologize, but I encountered an error processing your request. Please try again or contact support if the issue persists.', true);
            } finally {
                showTypingIndicator(false);
                isProcessing = false;
            }
        }

        function addUserMessage(message, saveHistory = true) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateX(-20px)';
            messageDiv.innerHTML = `
                <div class="message-avatar">👤</div>
                <div class="message-content">${escapeHtml(message)}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Smooth entrance animation for user messages
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateX(0)';
                
                // Smooth scroll after animation
                setTimeout(() => {
                    smoothScrollToBottom();
                }, 200);
            }, 50);
            
            if (saveHistory) {
                conversationHistory.push({
                    role: 'user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                saveConversationHistory();
            }
        }

        function addBotMessage(message, isError = false, saveHistory = true) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Enhance the message content for better display
            const enhancedMessage = enhanceMessageContent(message);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot message-entering';
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(30px)';
            messageDiv.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-content ${isError ? 'error' : ''}" style="opacity: 0;">
                    <div class="typing-placeholder">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Smooth entrance animation
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
                
                // Start typing animation after entrance
                setTimeout(() => {
                    const messageContent = messageDiv.querySelector('.message-content');
                    messageContent.style.transition = 'opacity 0.4s ease';
                    messageContent.style.opacity = '1';
                    
                    // Show typing indicator first
                    setTimeout(() => {
                        // Replace with actual content with typewriter effect
                        if (enhancedMessage.includes('<div class="structured-response')) {
                            // For structured responses, fade in directly
                            messageContent.innerHTML = enhancedMessage;
                            messageContent.classList.add('fade-in');
                        } else {
                            // For text responses, use typewriter effect
                            startTypewriterEffect(messageContent, enhancedMessage);
                        }
                    }, 800);
                }, 400);
                
                // Smooth scroll to bottom
                smoothScrollToBottom();
            }, 100);
            
            if (saveHistory) {
                conversationHistory.push({
                    role: 'assistant',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                saveConversationHistory();
            }
        }

        // Enhanced message content processing
        function enhanceMessageContent(message) {
            if (!message) return message;
            
            // If already contains HTML table structure from backend, preserve it
            if (message.includes('<table') && message.includes('class="plan-table"')) {
                return enhanceExistingHtmlTable(message);
            }
            
            // If already structured response, return as is
            if (message.includes('structured-response')) {
                return enhanceStructuredResponse(message);
            }
            
            // Auto-detect and enhance different content types
            if (message.includes('|') && message.includes('---')) {
                return enhanceTableContent(message);
            }
            
            if (message.includes('•') || message.includes('*') || message.includes('-')) {
                return enhanceListContent(message);
            }
            
            // Enhance plain text with better formatting
            return enhancePlainTextContent(message);
        }

        // Enhance existing HTML tables from backend
        function enhanceExistingHtmlTable(content) {
            console.log('🎨 Enhancing existing HTML table from backend');
            
            // Add enhanced-table class to existing tables
            let enhanced = content.replace(/<table([^>]*class="[^"]*plan-table[^"]*"[^>]*)>/g, 
                '<table$1 class="plan-table enhanced-table">');
            
            // If not already wrapped in structured-response, wrap it
            if (!enhanced.includes('structured-response')) {
                // Check if it's a standalone table
                if (enhanced.trim().startsWith('<table')) {
                    enhanced = `<div class="structured-response">
                        <div class="response-header">
                            <span class="header-icon">📊</span><strong>Plan Information</strong>
                        </div>
                        <div class="response-section">
                            ${enhanced}
                        </div>
                    </div>`;
                }
            }
            
            return enhanced;
        }

        // Enhance structured responses with better animations and interactivity
        function enhanceStructuredResponse(content) {
            // Add interaction handlers to tables if present
            let enhanced = content.replace(/<table[^>]*>/g, (match) => {
                return match.replace('>', ' class="enhanced-table">');
            });
            
            // Add hover effects to feature lists
            enhanced = enhanced.replace(/<ul class="feature-list">/g, '<ul class="feature-list enhanced-list">');
            
            return enhanced;
        }

        // Convert markdown-style tables to enhanced HTML tables
        function enhanceTableContent(content) {
            const tableRegex = /(\|[^|\n]+\|[^|\n]*\n)(\|[-\s|:]+\|[^|\n]*\n)((?:\|[^|\n]+\|[^|\n]*\n?)+)/g;
            
            return content.replace(tableRegex, (match, header, separator, rows) => {
                const headerCells = header.split('|').slice(1, -1).map(cell => cell.trim());
                const rowsArray = rows.trim().split('\n').map(row => 
                    row.split('|').slice(1, -1).map(cell => cell.trim())
                );
                
                let html = '<div class="structured-response">';
                html += '<div class="response-header"><span class="header-icon">📊</span><strong>Data Summary</strong></div>';
                html += '<div class="response-section">';
                html += '<table class="plan-table enhanced-table">';
                html += '<thead><tr>';
                headerCells.forEach(cell => {
                    html += `<th>${cell}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                rowsArray.forEach((row, index) => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td>${formatCellContent(cell)}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '</div></div>';
                return html;
            });
        }

        // Enhance list content with better visual structure
        function enhanceListContent(content) {
            // Convert bullet points to structured list
            let enhanced = content.replace(/[•\*\-]\s*([^\n]+)/g, '<li>$1</li>');
            
            if (enhanced.includes('<li>')) {
                enhanced = enhanced.replace(/(<li>.*<\/li>)/s, (match) => {
                    return `<div class="structured-response">
                        <div class="response-section">
                            <ul class="feature-list enhanced-list">${match}</ul>
                        </div>
                    </div>`;
                });
            }
            
            return enhanced;
        }

        // Enhance plain text with better typography and highlighting
        function enhancePlainTextContent(content) {
            let enhanced = content;
            
            // Highlight important numbers (amounts, percentages)
            enhanced = enhanced.replace(/₹[\d,]+/g, '<span class="highlight-amount">$&</span>');
            enhanced = enhanced.replace(/\d+%/g, '<span class="highlight-percentage">$&</span>');
            
            // Highlight status indicators
            enhanced = enhanced.replace(/\b(Eligible|Covered|Approved)\b/g, '<span class="status-success">$1</span>');
            enhanced = enhanced.replace(/\b(Not Eligible|Not Covered|Rejected|Excluded)\b/g, '<span class="status-error">$1</span>');
            enhanced = enhanced.replace(/\b(Partial|Conditional|Under Review)\b/g, '<span class="status-warning">$1</span>');
            
            // Convert to structured response for longer content
            if (enhanced.length > 200) {
                enhanced = `<div class="structured-response">
                    <div class="response-section">
                        <p>${enhanced}</p>
                    </div>
                </div>`;
            }
            
            return enhanced;
        }

        // Format individual cell content with appropriate styling
        function formatCellContent(content) {
            if (!content) return '';
            
            // Format currency
            if (content.match(/^\d+$/) && content.length > 3) {
                return `₹${parseInt(content).toLocaleString()}`;
            }
            
            // Format percentages
            if (content.includes('%')) {
                return `<span class="highlight-percentage">${content}</span>`;
            }
            
            // Format status values
            if (['Yes', 'Covered', 'Eligible', 'Available'].includes(content)) {
                return `<span class="status-success">${content}</span>`;
            }
            
            if (['No', 'Not Covered', 'Excluded', 'Not Available'].includes(content)) {
                return `<span class="status-error">${content}</span>`;
            }
            
            return content;
        }

        function clearEmptyState() {
            const chatMessages = document.getElementById('chatMessages');
            const emptyChat = chatMessages.querySelector('.empty-chat');
            if (emptyChat) {
                emptyChat.remove();
            }
        }

        function showTypingIndicator(show) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = show ? 'block' : 'none';
            
            if (show) {
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Smooth scrolling function
        function smoothScrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            const start = chatMessages.scrollTop;
            const end = chatMessages.scrollHeight - chatMessages.clientHeight;
            const distance = end - start;
            const duration = 600;
            let startTime = null;

            function animate(currentTime) {
                if (startTime === null) startTime = currentTime;
                const timeElapsed = currentTime - startTime;
                const progress = Math.min(timeElapsed / duration, 1);
                
                // Ease-out cubic function for smooth deceleration
                const easeOut = 1 - Math.pow(1 - progress, 3);
                
                chatMessages.scrollTop = start + (distance * easeOut);
                
                if (timeElapsed < duration) {
                    requestAnimationFrame(animate);
                }
            }
            
            requestAnimationFrame(animate);
        }

        // Typewriter effect function
        function startTypewriterEffect(element, content) {
            // Remove typing indicator
            element.innerHTML = '';
            
            // Strip HTML for plain text typewriter effect
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const plainText = tempDiv.textContent || tempDiv.innerText || '';
            
            let index = 0;
            const speed = 30; // Milliseconds per character
            
            function typeCharacter() {
                if (index < plainText.length) {
                    element.textContent = plainText.substring(0, index + 1);
                    index++;
                    
                    // Add cursor effect
                    if (index < plainText.length) {
                        element.textContent += '|';
                    }
                    
                    setTimeout(() => {
                        if (index <= plainText.length) {
                            element.textContent = plainText.substring(0, index);
                        }
                        typeCharacter();
                    }, speed);
                } else {
                    // Remove cursor and show final content
                    element.innerHTML = content;
                    element.classList.add('fade-in');
                }
            }
            
            typeCharacter();
        }

        // Plan info display functions
        function showPlanInfo(planData) {
            const planInfo = document.getElementById('planInfo');
            const planDescription = document.getElementById('planDescription');
            
            if (planInfo && planDescription && planData) {
                planInfo.style.display = 'block';
                planDescription.innerHTML = `
                    <p><strong>Company:</strong> ${planData.company || 'N/A'}</p>
                    <p><strong>Plan:</strong> ${planData.planName || 'N/A'}</p>
                    <p><strong>Coverage:</strong> ₹${planData.sumInsured || 'N/A'}</p>
                    ${planData.fullData ? '<p><strong>Status:</strong> ✅ Full plan data loaded</p>' : '<p><strong>Status:</strong> Basic info only</p>'}
                `;
            }
        }

        function hidePlanInfo() {
            const planInfo = document.getElementById('planInfo');
            if (planInfo) {
                planInfo.style.display = 'none';
            }
        }

        // Generate welcome message for selected plan
        function generateWelcomeMessage(planData) {
            if (!planData) return '';
            
            return `
                <div class="structured-response bounce-in">
                    <div class="response-header">
                        🎉 <strong>Welcome to Your AI Assistant!</strong>
                    </div>
                    <div class="response-section">
                        <div class="section-title slide-down">✅ Your Selected Plan</div>
                        <table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;" class="fade-in" style="animation-delay: 0.2s;">
                            <tr><th>Detail</th><th>Information</th></tr>
                            <tr><td><strong>Company</strong></td><td>${planData.company}</td></tr>
                            <tr><td><strong>Plan</strong></td><td>${planData.planName}</td></tr>
                            <tr><td><strong>Coverage</strong></td><td>₹${planData.sumInsured}</td></tr>
                            <tr><td><strong>Status</strong></td><td>${planData.fullData ? '✅ Full plan data loaded' : '📊 Basic info available'}</td></tr>
                        </table>
                    </div>
                    <div class="response-section">
                        <div class="section-title slide-down" style="animation-delay: 0.3s;">🤖 What I Can Help You With</div>
                        <table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;" class="fade-in" style="animation-delay: 0.4s;">
                            <tr><th>Category</th><th>Examples</th></tr>
                            <tr><td>🏥 <strong>Insurance & Claims</strong></td><td>Claim eligibility, policy terms, coverage details</td></tr>
                            <tr><td>💊 <strong>Health & Medical</strong></td><td>Medical conditions, treatments, health advice</td></tr>
                            <tr><td>💻 <strong>Technology</strong></td><td>Programming, software, troubleshooting</td></tr>
                            <tr><td>📚 <strong>Education</strong></td><td>Learning resources, explanations, research</td></tr>
                            <tr><td>💰 <strong>Finance</strong></td><td>Financial planning, investments, budgeting</td></tr>
                            <tr><td>🌟 <strong>General Knowledge</strong></td><td>Science, history, current events, facts</td></tr>
                        </table>
                    </div>
                    <div class="response-section">
                        <div class="section-title slide-down" style="animation-delay: 0.5s;">💡 Quick Start Examples</div>
                        <ul class="feature-list menu-options">
                            <li class="menu-option">💬 "What is covered under my insurance plan?"</li>
                            <li class="menu-option">🔍 "How do I file a claim for surgery?"</li>
                            <li class="menu-option">🏥 "What are the symptoms of diabetes?"</li>
                            <li class="menu-option">📚 "How do I learn Python programming?"</li>
                            <li class="menu-option">📈 "What are good investment options?"</li>
                            <li class="menu-option">🌍 "Tell me about climate change effects"</li>
                        </ul>
                    </div>
                    <div class="response-footer fade-in" style="animation-delay: 0.8s;">
                        Ask me anything! I'm designed to provide structured, comprehensive answers on a wide range of topics.
                    </div>
                </div>
            `;
        }

        // Enhanced welcome message for claim context
        function generateClaimContextWelcome() {
            return `
                <div class="structured-response">
                    <div class="response-header">
                        🤖 <strong>Plan Information & AI Assistant</strong>
                    </div>
                    <div class="response-section">
                        <div class="section-title">💼 <strong>Insurance Plan Assistance</strong></div>
                        <p>I specialize in helping you understand <strong>insurance plan details</strong> and provide <strong>general AI assistance</strong> for any topic.</p>
                        
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>📋 Note:</strong> For <strong>claim assessment and eligibility</strong>, please use the dedicated 
                            <a href="/claims" target="_blank" style="color: #007bff; text-decoration: underline;">Claim Assessment Tool</a>
                        </div>
                        
                        <table border="1" style="border-collapse: collapse; width: 100%; margin: 15px 0;">
                            <tr><th style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px;">Service Type</th><th style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px;">What I Can Help With</th></tr>
                            <tr><td>📋 <strong>Plan Information</strong></td><td>Coverage details, benefits, terms, plan comparison</td></tr>
                            <tr><td>💰 <strong>Insurance Guidance</strong></td><td>Policy features, waiting periods, sum insured options</td></tr>
                            <tr><td>💻 <strong>Technology Help</strong></td><td>Programming, software, apps, troubleshooting</td></tr>
                            <tr><td>📚 <strong>Education & Learning</strong></td><td>Explanations, research, academic help</td></tr>
                            <tr><td>� <strong>Finance & Business</strong></td><td>Investments, budgeting, business advice</td></tr>
                            <tr><td>🌍 <strong>General Knowledge</strong></td><td>Science, history, current events, any topic</td></tr>
                        </table>
                    </div>
                    <div class="response-section">
                        <div class="section-title">💡 Sample Questions</div>
                        <ul class="feature-list">
                            <li>🔍 <strong>Plans:</strong> "What are the key features of Health Assure plans?"</li>
                            <li>💊 <strong>Coverage:</strong> "Compare individual vs family floater plans"</li>
                            <li>💻 <strong>Tech:</strong> "How do I create a website?"</li>
                            <li>📊 <strong>Learning:</strong> "Explain machine learning concepts"</li>
                            <li>🌟 <strong>General:</strong> "What's the latest in renewable energy?"</li>
                        </ul>
                    </div>
                    <div class="response-footer">
                        🚀 Ask me about plan details or any topic you need help with! I'll provide structured, detailed responses.
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatus(message, type) {
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.textContent = message;
            statusIndicator.className = `status-indicator status-${type}`;
        }

        // Chat controls
        function clearCurrentChat() {
            if (confirm('Are you sure you want to clear the current chat? This action cannot be undone.')) {
                const chatMessages = document.getElementById('chatMessages');
                
                // Add clearing animation
                chatMessages.classList.add('chat-clearing');
                
                setTimeout(() => {
                    // Clear the chat
                    chatMessages.innerHTML = '';
                    
                    // Reset conversation and plan data
                    conversationHistory = [];
                    currentPlan = '';
                    
                    // Reset hidden selects
                    document.getElementById('companySelect').value = '';
                    document.getElementById('planSelect').value = '';
                    document.getElementById('planSelect').disabled = true;
                    document.getElementById('variantSelect').value = '';
                    document.getElementById('variantSelect').disabled = true;
                    hidePlanInfo();
                    
                    // Hide current plan display
                    document.getElementById('currentPlanInfo').style.display = 'none';
                    
                    saveConversationHistory();
                    
                    // Remove clearing animation and add cleared animation
                    chatMessages.classList.remove('chat-clearing');
                    chatMessages.classList.add('chat-cleared');
                    
                    // Show status with animation
                    showStatus('Chat cleared - Starting fresh!', 'connected');
                    
                    // Automatically show plan selection with delay for smooth transition
                    setTimeout(() => {
                        showPlanSelectionInChat();
                    }, 500);
                }, 400);
            }
        }

        function exportChat() {
            if (conversationHistory.length === 0) {
                alert('No conversation to export.');
                return;
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                plan: currentPlan ? PLAN_INFO[currentPlan].name : 'No plan selected',
                conversation: conversationHistory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-export-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Storage functions
        function saveConversationHistory() {
            try {
                localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
                
                // Also save as a session
                const sessions = getAllChatSessions();
                sessions.push({
                    timestamp: new Date().toISOString(),
                    plan: currentPlan,
                    messages: [...conversationHistory]
                });
                
                // Keep only last 50 sessions
                if (sessions.length > 50) {
                    sessions.splice(0, sessions.length - 50);
                }
                
                localStorage.setItem('chatSessions', JSON.stringify(sessions));
            } catch (error) {
                console.error('Failed to save conversation history:', error);
            }
        }

        function loadConversationHistory() {
            try {
                const savedHistory = localStorage.getItem('chatHistory');
                if (savedHistory) {
                    conversationHistory = JSON.parse(savedHistory);
                    
                    // Restore chat messages if any exist
                    if (conversationHistory.length > 0) {
                        clearEmptyState();
                        conversationHistory.forEach(msg => {
                            if (msg.role === 'user') {
                                addUserMessage(msg.content, false);
                            } else {
                                addBotMessage(msg.content, false, false);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load conversation history:', error);
            }
        }

        function getAllChatSessions() {
            try {
                const sessions = localStorage.getItem('chatSessions');
                return sessions ? JSON.parse(sessions) : [];
            } catch (error) {
                console.error('Failed to load chat sessions:', error);
                return [];
            }
        }

        // AI Response function - connects to actual backend API
        async function getAIResponse(message) {
            try {
                // Prepare request data
                const requestData = {
                    message: message,
                    sessionId: 'chat-session-' + Date.now(),
                    llmProvider: 'groq',
                    conversationHistory: conversationHistory.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }))
                };

                // Add plan context if available
                if (currentPlan && currentPlan.filePath) {
                    requestData.planId = currentPlan.filePath;
                    requestData.planContext = {
                        company: currentPlan.company,
                        planName: currentPlan.planName,
                        sumInsured: currentPlan.sumInsured
                    };
                }

                // Add claim context if available
                if (window.claimContext) {
                    requestData.claimContext = window.claimContext;
                }

                console.log('🚀 Sending chat request:', requestData);

                // Make API call to backend
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('✅ Chat response received:', result);

                // Return the formatted response
                return result.response || result.message || 'I received your message but had trouble generating a response.';

            } catch (error) {
                console.error('❌ Chat API error:', error);
                
                // Fallback response with helpful error information
                return `
                    <div class="structured-response">
                        <div class="response-header">
                            ⚠️ <strong>Connection Issue</strong>
                        </div>
                        <div class="response-section">
                            <p>I encountered an error while processing your request:</p>
                            <p style="color: #ef4444; font-family: monospace; font-size: 0.9rem;">${error.message}</p>
                        </div>
                        <div class="response-section">
                            <div class="section-title">💡 What you can try</div>
                            <ul class="feature-list">
                                <li>🔄 Try sending your message again</li>
                                <li>🔌 Check your internet connection</li>
                                <li>🔧 Refresh the page if the issue persists</li>
                                <li>� Contact support if problems continue</li>
                            </ul>
                        </div>
                        <div class="response-footer">
                            I'm here to help once the connection is restored
                        </div>
                    </div>
                `;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
